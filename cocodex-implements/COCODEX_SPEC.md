# COCODEX 요구사항 명세서

> 대화형 AI 코딩 어시스턴트 CLI 도구

---

## 1. 핵심 기능

### 1.1 멀티턴 대화

사용자와 AI가 종료할 때까지 계속 대화합니다.

```
You: 안녕
AI: 안녕하세요!
You: README.md 내용을 요약해줘
AI: (파일을 읽고) README.md는...
You: 고마워
AI: 천만에요!
You: (빈 입력 또는 /close)
```

**종료 조건**: 빈 입력, `/close` 명령어, 또는 EOF

---

### 1.2 자동 Tool 사용

AI가 필요하다고 판단하면 자동으로 파일 읽기/쓰기, 명령 실행 등을 수행합니다.

**필수 Tool**:
- **파일 읽기**: 경로 → 내용
- **파일 쓰기**: 경로, 내용 → 성공/실패
- **디렉토리 조회**: 경로 → 파일/폴더 목록
- **명령 실행**: 명령어 → stdout/stderr (타임아웃 30초)

**동작**:
```
사용자: "src 폴더에 뭐가 있어?"
  → AI: "디렉토리 조회 Tool을 써야겠다"
  → Tool 실행: list_dir("src")
  → 결과: ["index.ts", "utils.ts"]
  → AI: "src 폴더에는 index.ts와 utils.ts가 있습니다"
```

AI가 여러 Tool을 연속으로 사용할 수 있어야 합니다 (예: 파일 목록 조회 → 파일 읽기 → 분석).

---

### 1.3 커스텀 명령어

`/명령어 인자` 형식으로 미리 정의된 작업을 실행합니다.

#### 템플릿 명령어 (파일 기반)

`.cocodex/commands/analyze.md`:
```markdown
---
description: 코드 분석
---

다음 파일을 분석해주세요: ${ARGUMENTS}

1. 코드 품질
2. 잠재적 버그
3. 개선 제안
```

**사용**: `/analyze src/index.ts`
- `${ARGUMENTS}` → `src/index.ts`로 치환
- 치환된 프롬프트를 AI에게 전달

#### 내장 명령어 (코드)

- `/status`: 세션 상태 (메시지 수, 토큰 사용량) 출력 후 대화 계속
- `/compact`: 메시지 압축 실행 후 대화 계속
- `/close`: 대화 종료

**필수 템플릿 명령어**: `/analyze`, `/explain`, `/review`

---

### 1.4 프로젝트 컨텍스트 자동 로딩

프로그램 시작 시 `cocoagent.md` 파일을 찾아서 AI에게 전달합니다.

**탐색**:
1. 현재 디렉토리부터 시작
2. 부모 디렉토리로 올라가며 `cocoagent.md` 찾기
3. 루트까지 반복 (최대 10단계)
4. 찾은 모든 파일을 부모 → 현재 순서로 합침

**전달**: 대화 시작 시 첫 번째 메시지로 AI에게 전달 (사용자에게 보이지 않음)

---

### 1.5 지능형 메시지 압축

토큰이 많아지면 AI가 대화를 요약해서 압축합니다.

**트리거**:
- 자동: 토큰 사용률 70% 이상
- 수동: `/compact` 명령어

**압축 로직**:
1. 시스템 메시지 (컨텍스트 등) 보존
2. 최근 4개 메시지 보존
3. 중간 메시지들을 AI에게 요약 요청
4. 요약 결과를 "이전 대화 요약" 메시지로 삽입

**결과**: 메시지 수와 토큰 수 감소

---

### 1.6 세션 저장

대화 종료 시 `.cocodex/sessions/{세션ID}.json`에 저장합니다.

**저장 내용**:
- 세션 ID
- 생성/수정 시간
- 모든 메시지 (타입: `human`, `ai`, `system`, `tool`)

---

## 2. 동작 흐름

```
[시작]
  ↓
프로젝트 컨텍스트 로드
커스텀 명령어 로드
세션 생성
  ↓
┌─[대화 루프]──────────┐
│                      │
│ 사용자 입력          │
│   ↓                  │
│ 명령어인가?          │
│   Yes → 명령어 실행  │
│   No  → AI에게 전달  │
│   ↓                  │
│ AI 응답              │
│   ↓                  │
│ Tool 필요?           │
│   Yes → Tool 실행    │
│         AI 재호출    │
│   No  → 계속         │
│   ↓                  │
│ 압축 필요?           │
│   Yes → 압축 후 종료 │
│   No  → 계속         │
│                      │
└──────────────────────┘
  ↓
세션 저장
[종료]
```

---

## 3. 환경 설정

**환경 변수** (`.env`):
- `OPENAI_API_KEY` (필수)
- `OPENAI_MODEL` (선택, 기본값: gpt-4o)
- `OPENAI_TEMPERATURE` (선택, 기본값: 0.2)

**디렉토리 구조**:
```
.cocodex/
  commands/        # 템플릿 명령어
    analyze.md
    explain.md
    review.md
  sessions/        # 세션 저장 (자동 생성)
cocoagent.md       # 프로젝트 컨텍스트 (선택)
```

---

## 4. 검증 시나리오

이 시나리오들이 모두 작동하면 요구사항 충족:

1. **기본 대화**: 질문 → 답변 → 종료
2. **Tool 사용**: "README.md 읽어줘" → 파일 읽기 → 답변
3. **연속 Tool**: "src 폴더의 모든 파일을 읽고 요약해줘" → 디렉토리 조회 → 여러 파일 읽기 → 요약
4. **커스텀 명령어**: `/analyze src/index.ts` → 파일 읽기 → 분석
5. **멀티턴**: 여러 질문과 답변 반복
6. **컨텍스트**: `cocoagent.md`에 "프로젝트명: Cocodex" 작성 → "프로젝트명이 뭐야?" → "Cocodex입니다"
7. **압축**: `/status`로 토큰 확인 → `/compact`로 압축 → 메시지/토큰 감소 확인
8. **세션 저장**: 대화 종료 후 `.cocodex/sessions/*.json` 파일 생성 확인

---

## 5. 제약 사항

- Tool 실행 타임아웃: 30초
- AI 호출 최대 반복: 10회 (한 턴당, 무한루프 방지)
- 토큰 계산 정확도: ±10% 허용
- 압축 임계값: 70% (변경 가능)
- 최근 메시지 보존: 4개 (변경 가능)

---

## 6. 구현 자유도

**자유**: 프로그래밍 언어, 프레임워크, 상태 관리 방식, UI 스타일, 로그 형식

**고정**: 6가지 핵심 기능, 8가지 검증 시나리오, 환경 변수, 디렉토리 구조
